openapi: 3.0.3
info:
  title: Nexi Paygate Adapter Service
  description: |-
    This services provides methods to create and manage hosted payment pages.
    It also provides a valid callback endpoint for the Paygate
    service to notify us of change events.
  license:
    name: MIT
    url: https://github.com/eurofurence/reg-paygate-adapter/blob/main/LICENSE
  version: 0.1.0
servers:
  - url: /api/rest/v1
    description: localhost
tags:
  - name: paylinks
    description: Interface to the payment service
  - name: transactions
    description: Transactions management
  - name: callback
    description: Interface towards Nexi (callback)
  - name: info
    description: Health and other public status information
paths:
  /paylinks:
    post:
      tags:
        - paylinks
      summary: Create a new payment link
      description: |-
        Create a new checkout link with Nexi. The link can then be used for
        paying the defined amount and can be presented to the user by redirection from
        our shop page.

        When creating a link, the adapter automatically configures
        webhooks to receive notifications from Nexi about payment events,
        such as when a payment is created or completed.

        We intentionally work with as little information as possible. Specifically,
        we avoid attaching and personally identifiable information.
        
        Note that links created by this adapter expire after 12-24 hours.
      operationId: addPaymentLink
      requestBody:
        description: Create a new payment link
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentLinkRequest'
        required: true
      responses:
        '201':
          description: Successfully created
          headers:
            Location:
              schema:
                type: string
              description: URL of the created resource, ending in the assigned payment link id.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentLink'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authorization via API Token required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: An unexpected error occurred. A best effort attempt is made to return details in the body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: The Nexi backend could not be reached or returned an unexpected error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - ApiKeyAuth: []
  /paylinks/{id}:
    get:
      tags:
        - paylinks
      summary: Find payment link by id (NOT YET IMPLEMENTED)
      description: |-
        Returns a single link, fetching the current status from
        the downstream Nexi checkout backend.
      operationId: getPaymentLinkById
      parameters:
        - name: id
          in: path
          description: Id of the payment link to return
          required: true
          schema:
            type: integer
            minimum: 1
            format: int64
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentLink'
        '400':
          description: Invalid ID supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Payment link not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: An unexpected error occurred. A best effort attempt is made to return details in the body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: The Nexi backend could not be reached or returned an unexpected error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - ApiKeyAuth: []
    delete:
      tags:
        - paylinks
      summary: Delete a payment link by id (NOT YET IMPLEMENTED)
      description: Removes a checkout from the upstream Nexi backend
      operationId: deletePaymentLinkById
      parameters:
        - name: id
          in: path
          description: Id of the payment link to return
          required: true
          schema:
            type: integer
            minimum: 1
            format: int64
      responses:
        '204':
          description: successful operation
        '400':
          description: Invalid ID supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: You do not have permission to delete this payment link
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Payment link not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: An unexpected error occurred. A best effort attempt is made to return details in the body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: The Nexi backend could not be reached.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - ApiKeyAuth: []
  /paylinks/{id}/refund:
    post:
      tags:
        - paylinks
      summary: Refund payments by paylink id (NOT YET IMPLEMENTED)
      description: |-
        Refund all payments made using the references paylink.
      operationId: refundPaymentLinkById
      parameters:
        - name: id
          in: path
          description: Id of the payment link to refund
          required: true
          schema:
            type: integer
            minimum: 1
            format: int64
      responses:
        '204':
          description: successful operation
        '400':
          description: Invalid ID supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: You do not have permission to refund this payment link
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Payment link not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: An unexpected error occurred. A best effort attempt is made to return details in the body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: The Nexi backend could not be reached.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - ApiKeyAuth: []
  /webhook/{secret}:
    post:
      tags:
        - callback
      summary: Inform us that there is an update for a checkout
      description: |-
        Inform us that there is an update for a checkout
      operationId: webhookCallback
      parameters:
        - name: secret
          in: path
          description: secret as configured by us when setting up the webhook callback
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
        required: true
      responses:
        '200':
          description: Successfully received
        '400':
          description: Invalid json body supplied or reference to invoice id (paylink id) did not resolve
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: You failed to pass the correct secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: An unexpected error occurred. A best effort attempt is made to return details in the body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: The Nexi backend could not be reached (but then who is calling this webhook?)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /health:
    get:
      tags:
        - info
      summary: Get service health report
      description: Get service health report
      operationId: getHealthReport
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReport'
components:
  schemas:
    PaymentLinkRequest:
      type: object
      required:
        - reference_id
        - debitor_id
        - amount_due
        - currency
        - vat_rate
      properties:
        reference_id:
          type: string
          minLength: 1
          maxLength: 80
          description: Internal reference number for this payment process.
          example: ab23-1870ffe6-ca1778de7-0167
        debitor_id:
          type: integer
          format: int64
          minimum: 1
          description: The badge number of the attendee. Will be used to build appropriate description, referenceId, etc.
        amount_due:
          type: integer
          format: int64
          minimum: 1
          description: The amount to bill for. TODO - is this Cents or Euros?
          example: 95
        currency:
          type: string
          minLength: 3
          maxLength: 3
          description: The currency to use.
          example: EUR
        vat_rate:
          type: number
          format: float
          description: The applicable VAT, in percent.
          example: 19.0
    PaymentLink:
      type: object
      required:
        - purpose
        - reference_id
        - amount_due
        - currency
        - vat_rate
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 80
          description: The page title to be shown on the payment page.
          example: Payment of Eurofurence 27 registration fee for CrystalFox.
        description:
          type: string
          minLength: 1
          maxLength: 255
          description: The description to be shown on the payment page.
          example: Payment for Eurofurence 27 membership.
        reference_id:
          type: string
          minLength: 1
          maxLength: 80
          description: Internal reference number for this payment process.
          example: ab23-1870ffe6-ca1778de7-0167
        purpose:
          type: string
          minLength: 1
          maxLength: 255
          description: The purpose of this payment process.
          example: Payment of Eurofurence 27 registration fee for CrystalFox.
        amount_due:
          type: integer
          format: int64
          minimum: 1
          description: The amount to bill for. TODO - is this Cents or Euros?
          example: 95
        amount_paid:
          type: integer
          format: int64
          minimum: 0
          description: Only used in responses. The total amount paid. TODO - is this Cents or Euros?
          example: 95
        currency:
          type: string
          minLength: 3
          maxLength: 3
          description: The currency to use.
          example: EUR
        vat_rate:
          type: number
          format: float
          description: The applicable VAT, in percent.
          example: 19.0
        link:
          type: string
          minLength: 1
          maxLength: 255
          description: The payment link.
          example: https://instancename.pay-link.eu/?payment=382c85eab7a86278e3c3b06a23af2358
    WebhookEvent:
      type: object
      required:
        - payId
        - transId
        - status
        - responseCode
        - responseDescription
        - amount
        - paymentMethods
        - creationDate
      description: |-
        webhook event data structure.
      properties:
        payId:
          type: string
          description: identifier for payment, assigned by payment processor
          example: 78f5adccfe8640e5a549613389ff33we
        transId:
          type: string
          description: transaction id assigned by us, we use the reference id of the payment from payment-service
          example: EF1995-000001-221216-122218-4132
        refNr:
          type: string
          description: our reference number for the specific operation, we do not use this, so probably unset
        status:
          type: string
          description: status of the transaction
          example: OK
        responseCode:
          type: string
          description: response code of the transaction
          example: 00000000
        responseDescription:
          type: string
          description: description for the response code
          example: success
        amount:
          type: object
          additionalProperties: false
          required:
            - value
            - currency
          properties:
            value:
              type: number
              example: 10000
              description: integer amount in smallest denomination (for example cents)
            currency:
              type: string
              example: EUR
              description: ISO code for currency
        paymentMethods:
          type: array
          items:
            type: object
            additionalProperties: false
            required:
              - type
            properties:
              type:
                type: string
                enum:
                  - APPLEPAY
                  - CARD
                  - GOOGLEPAY
                example: CARD
        creationDate:
          type: string
          example: "2025-09-23T13:20:30Z"
    HealthReport:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Health status of this service.
          enum:
            - ok
            - unhealthy
          example: ok
    Error:
      type: object
      required:
        - message
        - timestamp
        - requestid
      properties:
        timestamp:
          type: string
          format: date-time
          description: The time at which the error occurred.
          example: 2006-01-02T15:04:05+07:00
        requestid:
          type: string
          description: An internal trace id assigned to the error. Used to find logs associated with errors across our services. Display to the user as something to communicate to us with inquiries about the error.
          example: a8b7c6d5
        message:
          type: string
          description: |-
            A keyed description of the error. We do not write human readable text here because the user interface will be multi language.
            
            At this time, there are these values:
            - paylink.parse.error (json body parse error)
            - paylink.data.invalid (field data failed to validate, see details for more information)
            - paylink.id.notfound (no such paylink number in the Nexi service)
            - paylink.id.invalid (syntactically invalid paylink id, must be positive integer)
            - paylink.downstream.error (downstream api failure)
            - attsrv.downstream.error (failed to call attendee service, and it isn't not found)
            - auth.unauthorized (token missing completely or invalid)
            - auth.forbidden (permissions missing)
            - webhook.parse.error (json body parse error)
            - webhook.data.invalid (syntactically invalid invoice number, must be positive integer)
            - webhook.downstream.error (downstream api failure)
            - unexpected (an unexpected error)
          example: paylink.data.invalid
        details:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Optional additional details about the error. If available, will usually contain English language technobabble.
          example:
            some_key: ["some English language technobabble that may or may not help you"]
            currency: ["configuration only allows CHF,EUR"]
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
      description: A shared secret used for local communication (also useful for local development)
